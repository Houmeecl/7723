<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VecinoXpress - Panel de Certificador RON</title>
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
  <style>
    :root {
      --primary: #2d219b;  /* Color principal VecinoXpress */
      --primary-light: #4939c7;
      --secondary: #3e3e3e;
      --background: #f8f8f8;
      --surface: #ffffff;
      --error: #d32f2f;
      --success: #388e3c;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--background);
      color: var(--secondary);
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .logo {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .logo img {
      height: 60px;
    }
    
    h1, h2, h3 {
      color: var(--primary);
      text-align: center;
    }
    
    .card {
      background-color: var(--surface);
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      overflow: hidden;
    }
    
    .card-header {
      background-color: var(--primary);
      color: white;
      padding: 15px 20px;
    }
    
    .card-header h2 {
      margin: 0;
      color: white;
      font-size: 1.5rem;
    }
    
    .card-content {
      padding: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }
    
    select, input, textarea {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background-color 0.3s;
      width: 100%;
    }
    
    button:hover {
      background-color: var(--primary-light);
    }
    
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    
    .video-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    @media (min-width: 768px) {
      .video-container {
        flex-direction: row;
      }
      
      .video-box {
        flex: 1;
      }
    }
    
    .video-box {
      position: relative;
    }
    
    .video-frame {
      width: 100%;
      height: 300px;
      background-color: #222;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .controls {
      display: flex;
      justify-content: center;
      margin-top: 10px;
      gap: 10px;
    }
    
    .control-button {
      background-color: var(--secondary);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .control-button:hover {
      background-color: var(--primary);
    }
    
    .session-info {
      margin-top: 20px;
    }
    
    .session-info dl {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 10px;
    }
    
    .session-info dt {
      font-weight: bold;
    }
    
    .status-bar {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 4px;
      text-align: center;
    }
    
    .hidden {
      display: none;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .btn-action {
      background-color: var(--success);
    }
    
    .btn-danger {
      background-color: var(--error);
    }
    
    .icon {
      display: inline-block;
      width: 24px;
      height: 24px;
      background-size: contain;
      background-repeat: no-repeat;
      vertical-align: middle;
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    
    @media (min-width: 768px) {
      .action-buttons {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }
    
    .action-button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background-color: white;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      background-color: var(--primary);
      color: white;
      padding: 15px 20px;
    }
    
    .modal-header h3 {
      margin: 0;
      color: white;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .modal-footer button {
      width: auto;
    }
    
    .footer-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      gap: 20px;
    }
    
    .footer-buttons button {
      flex: 1;
    }
    
    .session-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .session-item {
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .session-item:hover {
      background-color: #f0f0f0;
      border-color: var(--primary);
    }
    
    .session-item.selected {
      background-color: var(--primary-light);
      color: white;
      border-color: var(--primary);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <img src="/logo.png" alt="VecinoXpress Logo" onerror="this.src='https://via.placeholder.com/200x60/2d219b/ffffff?text=VecinoXpress'">
    </div>
    
    <h1>Panel de Certificador RON</h1>
    <p class="text-center">Verificación de identidad y firma electrónica en línea</p>
    
    <!-- Pantalla inicial de selección de sesión -->
    <div id="access-screen" class="card">
      <div class="card-header">
        <h2>Selecciona una sesión</h2>
      </div>
      <div class="card-content">
        <div class="form-group">
          <label for="session-select">Sesiones programadas</label>
          <select id="session-select">
            <option value="">Selecciona una sesión</option>
          </select>
        </div>
        <div id="session-list-container" class="hidden">
          <h3>Sesiones disponibles</h3>
          <ul id="session-list" class="session-list">
            <!-- Las sesiones se cargarán dinámicamente -->
          </ul>
        </div>
        <button id="joinButton" onclick="joinSession()">
          <span id="joinButtonText">Iniciar sesión</span>
          <span id="joinButtonLoading" class="loading hidden"></span>
        </button>
      </div>
    </div>
    
    <!-- Pantalla de sesión activa (inicialmente oculta) -->
    <div id="session-screen" class="hidden">
      <div class="video-container">
        <!-- Mi cámara -->
        <div class="video-box card">
          <div class="card-header">
            <h2>Mi cámara</h2>
          </div>
          <div class="card-content">
            <div id="local-player" class="video-frame"></div>
            <div class="controls">
              <button id="videoToggle" class="control-button" onclick="toggleVideo()">
                <span class="icon">📹</span>
              </button>
              <button id="audioToggle" class="control-button" onclick="toggleAudio()">
                <span class="icon">🎤</span>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Cliente -->
        <div class="video-box card">
          <div class="card-header">
            <h2>Cliente</h2>
          </div>
          <div class="card-content">
            <div id="remote-player" class="video-frame"></div>
            <div class="controls">
              <button class="control-button" onclick="captureSnapshot()">
                <span class="icon">📷</span>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Panel de control -->
      <div class="card">
        <div class="card-header">
          <h2>Control de sesión</h2>
        </div>
        <div class="card-content">
          <div class="session-info">
            <dl>
              <dt>ID de sesión:</dt>
              <dd id="sessionId">-</dd>
              
              <dt>Cliente:</dt>
              <dd id="clientName">-</dd>
              
              <dt>Documento:</dt>
              <dd id="documentName">-</dd>
              
              <dt>Estado:</dt>
              <dd id="sessionStatus">En proceso</dd>
            </dl>
          </div>
          
          <div class="action-buttons">
            <button class="action-button" onclick="showVerifyIdentityModal()">
              <span class="icon">👤</span>
              Verificar identidad
            </button>
            
            <button class="action-button" id="btnInitiateSignature" onclick="initiateSignature()" disabled>
              <span class="icon">✍️</span>
              Iniciar firma
            </button>
            
            <button class="action-button" onclick="showCertificateModal()">
              <span class="icon">📄</span>
              Generar constancia
            </button>
          </div>
          
          <div class="status-bar" id="statusBar">
            Esperando al cliente...
          </div>
          
          <div class="footer-buttons">
            <button onclick="cancelSession()" class="btn-danger">
              Cancelar sesión
            </button>
            
            <button onclick="completeSession()" class="btn-action">
              Completar sesión
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Modales -->
    <!-- Modal de verificación de identidad -->
    <div id="identityModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Verificación de identidad</h3>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="id-type">Tipo de documento</label>
            <select id="id-type">
              <option value="dni">Cédula de identidad</option>
              <option value="passport">Pasaporte</option>
              <option value="driver">Licencia de conducir</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="id-number">Número de documento</label>
            <input type="text" id="id-number" placeholder="Ej: 12345678-9">
          </div>
          
          <div class="form-group">
            <label for="verification-notes">Notas de verificación</label>
            <textarea id="verification-notes" placeholder="Detalles del proceso de verificación..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button onclick="closeModal('identityModal')">Cancelar</button>
          <button onclick="verifyIdentity()" class="btn-action">Confirmar verificación</button>
        </div>
      </div>
    </div>
    
    <!-- Modal de constancia -->
    <div id="certificateModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Generar constancia</h3>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="certificate-type">Tipo de constancia</label>
            <select id="certificate-type">
              <option value="verification">Verificación de identidad</option>
              <option value="signature">Firma electrónica</option>
              <option value="complete">Certificación completa</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="certificate-notes">Notas adicionales</label>
            <textarea id="certificate-notes" placeholder="Información adicional para la constancia..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button onclick="closeModal('certificateModal')">Cancelar</button>
          <button onclick="generateCertificate()" class="btn-action">Generar constancia</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Configuración Agora
    const APP_ID = "TU_APP_ID_AQUÍ"; // <-- Reemplazar con tu App ID real
    
    // Variables de estado
    let client;
    let localTracks = [];
    let remoteUsers = {};
    let isConnected = false;
    let videoEnabled = true;
    let audioEnabled = true;
    let sessionData = null;
    let identityVerified = false;
    let signatureInitiated = false;
    
    // Cargar sesiones disponibles (simulado para ejemplo)
    document.addEventListener('DOMContentLoaded', () => {
      // En una implementación real, cargarías las sesiones desde tu backend
      loadAvailableSessions();
    });
    
    // Cargar sesiones disponibles
    function loadAvailableSessions() {
      // Simulación de sesiones (en producción, cargar desde API)
      const mockSessions = [
        { sessionId: 'RON-2025-001', clientName: 'Juan Pérez', status: 'pending' },
        { sessionId: 'RON-2025-002', clientName: 'María González', status: 'pending' },
        { sessionId: 'RON-2025-003', clientName: 'Carlos Rodríguez', status: 'pending' }
      ];
      
      // Cargar en select
      const selectElement = document.getElementById('session-select');
      mockSessions.forEach(session => {
        const option = document.createElement('option');
        option.value = session.sessionId;
        option.textContent = `${session.sessionId} - ${session.clientName}`;
        selectElement.appendChild(option);
      });
      
      // Cargar en lista
      const listElement = document.getElementById('session-list');
      mockSessions.forEach(session => {
        const listItem = document.createElement('li');
        listItem.className = 'session-item';
        listItem.dataset.sessionId = session.sessionId;
        listItem.innerHTML = `
          <strong>${session.sessionId}</strong><br>
          Cliente: ${session.clientName}<br>
          Estado: ${formatStatus(session.status)}
        `;
        listItem.addEventListener('click', () => {
          // Deseleccionar todos
          document.querySelectorAll('.session-item').forEach(item => {
            item.classList.remove('selected');
          });
          
          // Seleccionar el actual
          listItem.classList.add('selected');
          
          // Actualizar select
          selectElement.value = session.sessionId;
        });
        listElement.appendChild(listItem);
      });
      
      // Mostrar lista si hay sesiones
      if (mockSessions.length > 0) {
        document.getElementById('session-list-container').classList.remove('hidden');
      }
    }
    
    // Unirse a sesión seleccionada
    async function joinSession() {
      const sessionId = document.getElementById('session-select').value;
      
      if (!sessionId) {
        alert('Por favor selecciona una sesión');
        return;
      }
      
      // Mostrar indicador de carga
      document.getElementById('joinButtonText').classList.add('hidden');
      document.getElementById('joinButtonLoading').classList.remove('hidden');
      document.getElementById('joinButton').disabled = true;
      
      try {
        // En una implementación real, aquí obtendrías información de la sesión desde tu backend
        // Para este ejemplo, simulamos la información
        
        const channelName = sessionId.replace('RON-', 'ron-session-');
        
        // Inicializar cliente Agora
        client = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
        
        // Configurar eventos
        client.on('user-published', handleUserPublished);
        client.on('user-unpublished', handleUserUnpublished);
        
        // Unirse al canal (sin token por ahora)
        await client.join(APP_ID, channelName, null, null);
        
        // Crear tracks locales
        localTracks = await AgoraRTC.createMicrophoneAndCameraTracks();
        const [audioTrack, videoTrack] = localTracks;
        
        // Mostrar video local
        videoTrack.play('local-player');
        
        // Publicar tracks
        await client.publish(localTracks);
        
        console.log('Joined channel successfully');
        
        // Simular datos de sesión (reemplazar con datos reales desde tu backend)
        sessionData = {
          sessionId: sessionId,
          clientName: 'Cliente que ha solicitado la sesión',
          documentName: 'Documento pendiente de firma',
          status: 'en-proceso'
        };
        
        // Actualizar información de sesión en la UI
        updateSessionInfo();
        
        // Cambiar a la pantalla de sesión
        document.getElementById('access-screen').classList.add('hidden');
        document.getElementById('session-screen').classList.remove('hidden');
        
        isConnected = true;
        
      } catch (error) {
        console.error('Error joining channel:', error);
        alert('Error al unirse a la sesión: ' + error.message);
        
        // Restaurar botón
        document.getElementById('joinButtonText').classList.remove('hidden');
        document.getElementById('joinButtonLoading').classList.add('hidden');
        document.getElementById('joinButton').disabled = false;
      }
    }
    
    // Manejar cuando otro usuario publica video/audio
    async function handleUserPublished(user, mediaType) {
      // Suscribirse al usuario remoto
      await client.subscribe(user, mediaType);
      
      // Si es video, mostrarlo en el contenedor remoto
      if (mediaType === 'video') {
        user.videoTrack.play('remote-player');
        
        // Actualizar interfaz
        updateUI('clientJoined');
      }
      
      // Si es audio, reproducirlo
      if (mediaType === 'audio') {
        user.audioTrack.play();
      }
      
      // Guardar usuario remoto
      remoteUsers[user.uid] = user;
    }
    
    // Manejar cuando otro usuario deja de publicar video/audio
    function handleUserUnpublished(user, mediaType) {
      if (mediaType === 'video') {
        // Limpiar contenedor de video remoto
        const playerElement = document.getElementById('remote-player');
        playerElement.innerHTML = '';
        
        // Actualizar interfaz
        updateUI('clientLeft');
      }
      
      // Eliminar usuario remoto
      delete remoteUsers[user.uid];
    }
    
    // Actualizar información de sesión en la UI
    function updateSessionInfo() {
      if (!sessionData) return;
      
      document.getElementById('sessionId').textContent = sessionData.sessionId || '-';
      document.getElementById('clientName').textContent = sessionData.clientName || '-';
      document.getElementById('documentName').textContent = sessionData.documentName || '-';
      document.getElementById('sessionStatus').textContent = formatStatus(sessionData.status) || 'En proceso';
    }
    
    // Formatear estado para mostrar en UI
    function formatStatus(status) {
      const statusMap = {
        'pending': 'Pendiente',
        'en-proceso': 'En proceso',
        'identity-verified': 'Identidad verificada',
        'signing': 'Firmando',
        'completed': 'Completado',
        'cancelled': 'Cancelado'
      };
      
      return statusMap[status] || status;
    }
    
    // Actualizar UI basado en eventos
    function updateUI(event) {
      const statusBar = document.getElementById('statusBar');
      
      switch (event) {
        case 'clientJoined':
          statusBar.textContent = 'Cliente conectado. Proceda con la verificación de identidad.';
          break;
          
        case 'clientLeft':
          statusBar.textContent = 'Cliente desconectado. Esperando reconexión...';
          break;
          
        case 'identityVerified':
          statusBar.textContent = 'Identidad verificada con éxito. Puede iniciar el proceso de firma.';
          document.getElementById('btnInitiateSignature').disabled = false;
          break;
          
        case 'signingStarted':
          statusBar.textContent = 'Proceso de firma iniciado. El cliente recibirá instrucciones por correo.';
          break;
          
        case 'sessionCompleted':
          statusBar.textContent = 'Sesión completada correctamente.';
          break;
      }
    }
    
    // Activar/desactivar cámara
    async function toggleVideo() {
      if (!isConnected || localTracks.length < 2) return;
      
      const videoTrack = localTracks[1];
      
      if (videoEnabled) {
        await videoTrack.setEnabled(false);
        document.getElementById('videoToggle').innerHTML = '<span class="icon">🚫</span>';
      } else {
        await videoTrack.setEnabled(true);
        document.getElementById('videoToggle').innerHTML = '<span class="icon">📹</span>';
      }
      
      videoEnabled = !videoEnabled;
    }
    
    // Activar/desactivar micrófono
    async function toggleAudio() {
      if (!isConnected || localTracks.length < 1) return;
      
      const audioTrack = localTracks[0];
      
      if (audioEnabled) {
        await audioTrack.setEnabled(false);
        document.getElementById('audioToggle').innerHTML = '<span class="icon">🔇</span>';
      } else {
        await audioTrack.setEnabled(true);
        document.getElementById('audioToggle').innerHTML = '<span class="icon">🎤</span>';
      }
      
      audioEnabled = !audioEnabled;
    }
    
    // Capturar imagen del cliente
    function captureSnapshot() {
      // En una implementación real, capturarías un frame del video y lo enviarías al servidor
      alert('Imagen capturada como evidencia de verificación');
    }
    
    // Mostrar modal de verificación de identidad
    function showVerifyIdentityModal() {
      document.getElementById('identityModal').classList.add('active');
    }
    
    // Mostrar modal de constancia
    function showCertificateModal() {
      document.getElementById('certificateModal').classList.add('active');
    }
    
    // Cerrar modal
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }
    
    // Verificar identidad del cliente
    function verifyIdentity() {
      const idType = document.getElementById('id-type').value;
      const idNumber = document.getElementById('id-number').value;
      const notes = document.getElementById('verification-notes').value;
      
      if (!idNumber || !notes) {
        alert('Por favor completa todos los campos');
        return;
      }
      
      // En una implementación real, enviarías esta información a tu backend
      
      // Actualizar estado
      identityVerified = true;
      sessionData.status = 'identity-verified';
      updateSessionInfo();
      updateUI('identityVerified');
      
      // Cerrar modal
      closeModal('identityModal');
      
      // Notificar
      alert('Identidad verificada correctamente');
    }
    
    // Iniciar proceso de firma
    function initiateSignature() {
      if (!identityVerified) {
        alert('Primero debe verificar la identidad del cliente');
        return;
      }
      
      // En una implementación real, iniciarías el proceso de firma con Zoho Sign
      
      // Actualizar estado
      signatureInitiated = true;
      sessionData.status = 'signing';
      updateSessionInfo();
      updateUI('signingStarted');
      
      // Notificar
      alert('Proceso de firma iniciado correctamente. El cliente ha sido notificado por correo electrónico.');
    }
    
    // Generar constancia de certificación
    function generateCertificate() {
      const certificateType = document.getElementById('certificate-type').value;
      const notes = document.getElementById('certificate-notes').value;
      
      if (!notes) {
        alert('Por favor ingresa notas para la constancia');
        return;
      }
      
      // En una implementación real, generarías la constancia y la enviarías al cliente
      
      // Cerrar modal
      closeModal('certificateModal');
      
      // Notificar
      alert('Constancia generada correctamente. Se enviará automáticamente al cliente por correo electrónico.');
    }
    
    // Cancelar sesión
    function cancelSession() {
      if (confirm('¿Está seguro de que desea cancelar esta sesión?')) {
        endSession();
      }
    }
    
    // Completar sesión
    function completeSession() {
      if (!identityVerified) {
        alert('Debe verificar la identidad del cliente antes de completar la sesión');
        return;
      }
      
      if (confirm('¿Está seguro de que desea completar esta sesión?')) {
        // Actualizar estado
        sessionData.status = 'completed';
        updateSessionInfo();
        updateUI('sessionCompleted');
        
        // En una implementación real, actualizarías el estado en el backend
        
        setTimeout(() => {
          endSession();
        }, 3000);
      }
    }
    
    // Finalizar sesión y liberar recursos
    async function endSession() {
      if (!isConnected) return;
      
      // Detener y cerrar tracks locales
      for (let track of localTracks) {
        track.stop();
        track.close();
      }
      
      // Dejar el canal
      await client.leave();
      
      // Reiniciar variables
      localTracks = [];
      remoteUsers = {};
      isConnected = false;
      identityVerified = false;
      signatureInitiated = false;
      
      // Volver a la pantalla de acceso
      document.getElementById('session-screen').classList.add('hidden');
      document.getElementById('access-screen').classList.remove('hidden');
      
      // Restaurar botón
      document.getElementById('joinButtonText').classList.remove('hidden');
      document.getElementById('joinButtonLoading').classList.add('hidden');
      document.getElementById('joinButton').disabled = false;
      document.getElementById('btnInitiateSignature').disabled = true;
      
      // Limpiar selección
      document.getElementById('session-select').value = '';
      document.querySelectorAll('.session-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Limpiar contenedores de video
      document.getElementById('local-player').innerHTML = '';
      document.getElementById('remote-player').innerHTML = '';
      
      console.log('Session ended successfully');
    }
  </script>
</body>
</html>